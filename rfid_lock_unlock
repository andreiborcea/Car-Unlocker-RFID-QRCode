#include <SPI.h>
#include <RFID.h>
#include <LiquidCrystal.h>
/* RFID READER PINS */
#define SDA_DIO 10  // Pin 53 Arduino Mega
#define RESET_DIO 9
#define delayRead 1000 // Tempo 


RFID RC522(SDA_DIO, RESET_DIO); 
  // inserire tutti i codici esadecimali delle schede magnetiche riconosciute 
String codiceAutorizzato1 = "XXXXXXXXXX";
String codiceAutorizzato2 = "XXXXXXXXXX";
String codiceAutorizzato3 = "XXXXXXXXXX";

bool bloccata=false;

void setup()
{ 
  Serial.begin(9600);
  /*SPI ON*/
  SPI.begin(); 
  /*INIT RFID READER*/
  RC522.init();
  Serial.println("Setup");
  if(bloccata==false)
  Serial.println("Stato attuale della macchina: Aperta");
  else
  Serial.println("Stato attuale della macchina: Chiusa");
  pinMode(6,OUTPUT);
  pinMode(7,OUTPUT);
  
 
}
  
void loop()
{
  /* Temporary loop counter */
  byte i;
  // Se viene letta una tessera
  if (RC522.isCard())
  {
    // READ CARD SERIAL
    RC522.readCardSerial();
    String codiceLetto ="";
    Serial.println("Codice delle tessera letto:");
  
    // COnvert hex value to string
    for(i = 0; i <= 4; i++)
    {
      codiceLetto+= String (RC522.serNum[i],HEX);
      codiceLetto.toUpperCase();
    }
    Serial.println(codiceLetto);
    if(verificaCodice(codiceLetto,codiceAutorizzato1)||verificaCodice(codiceLetto,codiceAutorizzato2)
    ||verificaCodice(codiceLetto,codiceAutorizzato3)){
      Serial.println("Tessera autorizzata");
      delay(1000);
      /*In my car i use a rele in order to lock and unlock the car*/
      
      if(bloccata)
      {
        Serial.println("Stato macchina: chiusa");
          digitalWrite(6,HIGH);
          delay(2000);
          digitalWrite(6,LOW);
          Serial.println("Stato macchina: aperta");
          bloccata=false;
          
          
      }
      else
      {
         Serial.println("Stato macchina: aperta");
        digitalWrite(7,HIGH);              // wait few milliseconds
        delay(2000);
        digitalWrite(7,LOW);
        Serial.println("Stato macchina: chiusa");
        bloccata=true;
      }
      
    }else{
      Serial.println("Tessera non autorizzata");
      
     
    }
  //delay(delayRead);  
  }
}
// Questa funzione verifica se il codice Letto Ã¨ autorizzato
boolean verificaCodice(String codiceLetto, String codiceAutorizzato){

  if(codiceLetto.equals(codiceAutorizzato)){
    return true;
  }else{
    return false;
  }  
}    

